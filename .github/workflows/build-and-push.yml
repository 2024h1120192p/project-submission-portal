name: Build and Push Docker Images

on:
  push:
    branches:
      - main
    paths:
      - 'services/**'
      - 'libs/**'
      - 'config/**'
      - 'requirements.txt'
      - '.github/workflows/build-and-push.yml'
      - 'argocd-app.yaml'
      - 'k8s/**'

# Needed so the workflow can commit updated manifests back to the repo
permissions:
  contents: write

env:
  DOCKER_REGISTRY: h20240192/ss_g527.paper-submission-portal

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      digests: ${{ steps.collect-digests.outputs.digests }}
    
    strategy:
      matrix:
        service:
          - users_service
          - gateway
          - analytics_service
          - notification_service
          - plagiarism_service
          - submission_service
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Build Docker image
        run: |
          docker build \
            -f ./services/${{ matrix.service }}/Dockerfile \
            -t ${{ env.DOCKER_REGISTRY }}:${{ matrix.service }}-${{ github.sha }} \
            -t ${{ env.DOCKER_REGISTRY }}:${{ matrix.service }}-latest \
            .
      
      - name: Push Docker image and capture digest
        id: push
        run: |
          # Push the SHA-tagged image and capture its digest
          docker push ${{ env.DOCKER_REGISTRY }}:${{ matrix.service }}-${{ github.sha }} | tee push_output.txt
          DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' ${{ env.DOCKER_REGISTRY }}:${{ matrix.service }}-${{ github.sha }} | cut -d'@' -f2)
          
          # Also push latest tag
          docker push ${{ env.DOCKER_REGISTRY }}:${{ matrix.service }}-latest
          
          echo "digest=${DIGEST}" >> $GITHUB_OUTPUT
          echo "service=${{ matrix.service }}" >> $GITHUB_OUTPUT
          echo "Image pushed: ${{ env.DOCKER_REGISTRY }}:${{ matrix.service }}-${{ github.sha }}"
          echo "Digest: ${DIGEST}"
      
      - name: Save digest to artifact
        run: |
          mkdir -p digests
          echo "${{ steps.push.outputs.service }}=${{ steps.push.outputs.digest }}" > digests/${{ matrix.service }}.txt
      
      - name: Upload digest artifact
        uses: actions/upload-artifact@v4
        with:
          name: digest-${{ matrix.service }}
          path: digests/${{ matrix.service }}.txt
          retention-days: 1

  update-manifests:
    name: Bump K8s manifests to new images
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Checkout repo (full)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Download all digest artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: digest-*
          path: digests
          merge-multiple: true
      
      - name: Install yq
        run: |
          set -e
          YQ_VERSION=v4.44.3
          wget -q "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_amd64" -O yq
          sudo mv yq /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq
          yq --version
      
      - name: Update image digests in k8s manifests
        env:
          DOCKER_REGISTRY: ${{ env.DOCKER_REGISTRY }}
        run: |
          set -euo pipefail
          services=(users_service gateway analytics_service notification_service plagiarism_service submission_service)
          
          # Read digests from artifacts
          declare -A digests
          for svc in "${services[@]}"; do
            digest_file="digests/${svc}.txt"
            if [[ -f "${digest_file}" ]]; then
              digest=$(cut -d'=' -f2 < "${digest_file}")
              digests["${svc}"]="${digest}"
              echo "Found digest for ${svc}: ${digest}"
            else
              echo "ERROR: Missing digest for ${svc}"
              exit 1
            fi
          done
          
          # Update manifests with digests
          for svc in "${services[@]}"; do
            dir="${svc//_/-}"
            file="k8s/${dir}/deployment.yaml"
            img="${DOCKER_REGISTRY}@${digests[${svc}]}"
            echo "Updating ${file} -> ${img}"
            NAME="${dir}" IMAGE="${img}" yq -i '(.spec.template.spec.containers[] | select(.name == env(NAME)).image) = env(IMAGE)' "${file}"
          done
          
          echo "Changed files:"; git status --porcelain
      
      - name: Commit and push manifest changes
        env:
          GIT_AUTHOR_NAME: github-actions[bot]
          GIT_AUTHOR_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com
          GIT_COMMITTER_NAME: github-actions[bot]
          GIT_COMMITTER_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com
        run: |
          set -e
          if [[ -n "$(git status --porcelain k8s)" ]]; then
            git add k8s
            git commit -m "CI: bump k8s images to digest @${{ github.sha }}"
            git push
          else
            echo "No manifest changes to commit."
          fi
