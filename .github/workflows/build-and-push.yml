name: Build and Push Docker Images

on:
  push:
    branches:
      - main
    paths:
      - 'services/**'
      - 'libs/**'
      - 'config/**'
      - 'requirements.txt'
      - '.github/workflows/build-and-push.yml'
      - 'argocd-app.yaml'
      - 'k8s/**'

# Needed so the workflow can commit updated manifests back to the repo
permissions:
  contents: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    environment: dev
    outputs:
      digests: ${{ steps.collect-digests.outputs.digests }}
    
    env:
      DOCKER_REGISTRY: ${{ vars.DOCKER_REGISTRY }}
    
    strategy:
      matrix:
        service:
          - users_service
          - gateway
          - analytics_service
          - notification_service
          - plagiarism_service
          - submission_service
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Create .env file from GitHub secrets
        run: |
          cat > .env << 'ENVFILE'
          # Environment configuration for Paper Submission Portal
          # Generated from GitHub secrets during CI/CD
          
          LOG_LEVEL=info
          ENVIRONMENT=production
          
          # Cloud SQL
          CLOUDSQL_CONNECTION_NAME=${{ vars.CLOUDSQL_CONNECTION_NAME }}
          POSTGRES_HOST=127.0.0.1
          POSTGRES_PORT=5432
          POSTGRES_DB=paper_portal
          POSTGRES_USER=${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          
          # Service URLs (K8s DNS)
          USERS_SERVICE_URL=http://users-service:8001
          SUBMISSION_SERVICE_URL=http://submission-service:8002
          PLAGIARISM_SERVICE_URL=http://plagiarism-service:8003
          ANALYTICS_SERVICE_URL=http://analytics-service:8004
          NOTIFICATION_SERVICE_URL=http://notification-service:8005
          GATEWAY_URL=http://gateway:8000
          
          # Kafka (MSK)
          KAFKA_BROKER=${{ vars.KAFKA_BROKER }}
          KAFKA_TOPIC_SUBMISSION_UPLOADED=paper_uploaded
          KAFKA_TOPIC_PLAGIARISM_CHECKED=plagiarism_checked
          
          # Firestore
          FIRESTORE_DATABASE=${{ vars.FIRESTORE_DATABASE }}
          
          # S3 Buckets
          S3_SUBMISSION_BUCKET=${{ vars.S3_SUBMISSION_BUCKET }}
          S3_CHECKPOINT_BUCKET=${{ vars.S3_CHECKPOINT_BUCKET }}
          
          # Flink
          FLINK_MODE=managed
          FLINK_MANAGED_ENDPOINT=${{ vars.FLINK_MANAGED_ENDPOINT }}
          
          # Application
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          UPLOAD_DIR=/tmp/uploads
          MAX_UPLOAD_SIZE=10485760
          ENVFILE
          
          echo "âœ“ .env file created with configuration from GitHub secrets"
          # Show non-sensitive values for verification
          grep -v "PASSWORD\|SECRET_KEY" .env || true
      
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Build Docker image with .env
        run: |
          docker build \
            -f ./services/${{ matrix.service }}/Dockerfile \
            -t ${{ env.DOCKER_REGISTRY }}:${{ matrix.service }}-latest \
            --build-arg ENV_FILE=.env \
            .
      
      - name: Push Docker image and capture digest
        id: push
        run: |
          # Push the latest tag image and capture its digest
          docker push ${{ env.DOCKER_REGISTRY }}:${{ matrix.service }}-latest
          DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' ${{ env.DOCKER_REGISTRY }}:${{ matrix.service }}-latest | cut -d'@' -f2)
          
          echo "digest=${DIGEST}" >> $GITHUB_OUTPUT
          echo "service=${{ matrix.service }}" >> $GITHUB_OUTPUT
          echo "Image pushed: ${{ env.DOCKER_REGISTRY }}:${{ matrix.service }}-latest"
          echo "Digest: ${DIGEST}"
      
      - name: Save digest to artifact
        run: |
          mkdir -p digests
          echo "${{ steps.push.outputs.service }}=${{ steps.push.outputs.digest }}" > digests/${{ matrix.service }}.txt
      
      - name: Upload digest artifact
        uses: actions/upload-artifact@v4
        with:
          name: digest-${{ matrix.service }}
          path: digests/${{ matrix.service }}.txt
          retention-days: 1

  update-manifests:
    name: Bump K8s manifests to new images
    runs-on: ubuntu-latest
    environment: dev
    needs: build-and-push
    steps:
      - name: Checkout repo (full)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Download all digest artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: digest-*
          path: digests
          merge-multiple: true
      
      - name: Install yq
        run: |
          set -e
          YQ_VERSION=v4.44.3
          wget -q "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_amd64" -O yq
          sudo mv yq /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq
          yq --version
      
      - name: Update image digests in ArgoCD manifests
        env:
          DOCKER_REGISTRY: ${{ env.DOCKER_REGISTRY }}
        run: |
          set -euo pipefail
          services=(users_service gateway analytics_service notification_service plagiarism_service submission_service)
          
          # Read digests from artifacts
          declare -A digests
          for svc in "${services[@]}"; do
            digest_file="digests/${svc}.txt"
            if [[ -f "${digest_file}" ]]; then
              digest=$(cut -d'=' -f2 < "${digest_file}")
              digests["${svc}"]="${digest}"
              echo "Found digest for ${svc}: ${digest}"
            else
              echo "ERROR: Missing digest for ${svc}"
              exit 1
            fi
          done
          
          # Update manifests with digests in k8s/.argocd folder
          for svc in "${services[@]}"; do
            dir="${svc//_/-}"
            file="k8s/.argocd/${dir}-deployment.txt"
            img="${DOCKER_REGISTRY}@${digests[${svc}]}"
            echo "Updating ${file} -> ${img}"
            NAME="${dir}" IMAGE="${img}" yq -i '(.spec.template.spec.containers[] | select(.name == env(NAME)).image) = env(IMAGE)' "${file}"
          done
          
          echo "Changed files:"; git status --porcelain
      
      - name: Commit and push manifest changes
        env:
          GIT_AUTHOR_NAME: github-actions[bot]
          GIT_AUTHOR_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com
          GIT_COMMITTER_NAME: github-actions[bot]
          GIT_COMMITTER_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com
        run: |
          set -e
          if [[ -n "$(git status --porcelain k8s/.argocd)" ]]; then
            git add k8s/.argocd
            git commit -m "CI: bump ArgoCD image digests to latest"
            git push
          else
            echo "No manifest changes to commit."
          fi
