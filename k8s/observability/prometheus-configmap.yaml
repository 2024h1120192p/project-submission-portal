apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-additional-scrape-configs
  namespace: observability
data:
  additional-scrape-configs.yaml: |
    # Application Services
    - job_name: 'gateway-service'
      kubernetes_sd_configs:
        - role: pod
          namespaces:
            names:
              - paper-submission-portal
      relabel_configs:
        - source_labels: [__meta_kubernetes_pod_label_app]
          action: keep
          regex: gateway
        - source_labels: [__meta_kubernetes_pod_port_name]
          action: keep
          regex: metrics
        - source_labels: [__meta_kubernetes_pod_name]
          target_label: pod
        - source_labels: [__meta_kubernetes_pod_label_app]
          target_label: job

    - job_name: 'submission-service'
      kubernetes_sd_configs:
        - role: pod
          namespaces:
            names:
              - paper-submission-portal
      relabel_configs:
        - source_labels: [__meta_kubernetes_pod_label_app]
          action: keep
          regex: submission-service
        - source_labels: [__meta_kubernetes_pod_port_name]
          action: keep
          regex: metrics
        - source_labels: [__meta_kubernetes_pod_name]
          target_label: pod
        - source_labels: [__meta_kubernetes_pod_label_app]
          target_label: job

    - job_name: 'analytics-service'
      kubernetes_sd_configs:
        - role: pod
          namespaces:
            names:
              - paper-submission-portal
      relabel_configs:
        - source_labels: [__meta_kubernetes_pod_label_app]
          action: keep
          regex: analytics-service
        - source_labels: [__meta_kubernetes_pod_port_name]
          action: keep
          regex: metrics
        - source_labels: [__meta_kubernetes_pod_name]
          target_label: pod
        - source_labels: [__meta_kubernetes_pod_label_app]
          target_label: job

    - job_name: 'plagiarism-service'
      kubernetes_sd_configs:
        - role: pod
          namespaces:
            names:
              - paper-submission-portal
      relabel_configs:
        - source_labels: [__meta_kubernetes_pod_label_app]
          action: keep
          regex: plagiarism-service
        - source_labels: [__meta_kubernetes_pod_port_name]
          action: keep
          regex: metrics
        - source_labels: [__meta_kubernetes_pod_name]
          target_label: pod
        - source_labels: [__meta_kubernetes_pod_label_app]
          target_label: job

    - job_name: 'notification-service'
      kubernetes_sd_configs:
        - role: pod
          namespaces:
            names:
              - paper-submission-portal
      relabel_configs:
        - source_labels: [__meta_kubernetes_pod_label_app]
          action: keep
          regex: notification-service
        - source_labels: [__meta_kubernetes_pod_port_name]
          action: keep
          regex: metrics
        - source_labels: [__meta_kubernetes_pod_name]
          target_label: pod
        - source_labels: [__meta_kubernetes_pod_label_app]
          target_label: job

    - job_name: 'users-service'
      kubernetes_sd_configs:
        - role: pod
          namespaces:
            names:
              - paper-submission-portal
      relabel_configs:
        - source_labels: [__meta_kubernetes_pod_label_app]
          action: keep
          regex: users-service
        - source_labels: [__meta_kubernetes_pod_port_name]
          action: keep
          regex: metrics
        - source_labels: [__meta_kubernetes_pod_name]
          target_label: pod
        - source_labels: [__meta_kubernetes_pod_label_app]
          target_label: job

    # Kubernetes API Server
    - job_name: 'kubernetes-apiservers'
      kubernetes_sd_configs:
        - role: endpoints
      scheme: https
      tls_config:
        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
      relabel_configs:
        - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]
          action: keep
          regex: default;kubernetes;https

    # Node Exporter (already part of kube-prometheus-stack)
    - job_name: 'node-exporter'
      kubernetes_sd_configs:
        - role: endpoints
      relabel_configs:
        - source_labels: [__meta_kubernetes_endpoints_name]
          action: keep
          regex: kube-prometheus-stack-prometheus-node-exporter
